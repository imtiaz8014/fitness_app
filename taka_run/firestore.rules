rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read their own profile
    // Writes go through Cloud Functions (Admin SDK bypasses rules)
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // Markets: any authenticated user can read, writes go through Cloud Functions
    match /markets/{marketId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Bets: users can only read their own bets
    // Market bet summaries are served via Cloud Functions
    match /bets/{betId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;
    }

    // Comments: any authenticated user can read, writes go through Cloud Functions
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Custodial wallets — Cloud Functions only (Admin SDK bypasses rules)
    match /wallets/{userId} {
      allow read, write: if false;
    }

    // App config — Cloud Functions only
    match /config/{docId} {
      allow read, write: if false;
    }

    // Users can only read their own runs
    // Writes go through Cloud Functions (Admin SDK bypasses rules)
    match /runs/{runId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;

      // GPS points subcollection
      match /gpsPoints/{pointId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/runs/$(runId)).data.userId == request.auth.uid;
        allow write: if false;
      }
    }
  }
}
